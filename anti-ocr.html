<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti-OCR FreeNetGuard</title>
    <style>
        #canvas {
            border: 1px solid black;
            background-color: #fff;
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        textarea, input {
            padding: 10px;
            font-size: 16px;
            margin: 10px 0;
            width: 80%;
            max-width: 500px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- 输入文本框 -->
    <textarea id="textInput" placeholder="请输入文字" rows="4"></textarea><br>
    <!-- 每行最大字符数输入框 -->
    <input id="maxCharsInput" type="number" min="1" value="30" placeholder="每行最大字符数"><br>
    <!-- 生成图片按钮 -->
    <button onclick="generateImage()">生成图片</button><br><br>
    <!-- 画布 -->
    <canvas id="canvas" width="600" height="400"></canvas>

    <script>
        function generateImage() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            const text = document.getElementById('textInput').value.trim();
            const maxCharsPerLine = parseInt(document.getElementById('maxCharsInput').value, 10);

            // 输入验证
            if (isNaN(maxCharsPerLine) || maxCharsPerLine < 1) {
                alert('每行最大字符数必须为正整数');
                return;
            }

            if (text.length === 0) {
                alert('请输入要生成图片的文字');
                return;
            }

            const lines = splitTextIntoLines(text, maxCharsPerLine);
            const lineHeight = 45; // 增加行高以适应更大的字体
            const xOffset = 50; // 增加X轴偏移量
            const yOffset = 50; // 增加Y轴偏移量

            ctx.font = '40px Arial'; // 字体大小
            ctx.fillStyle = 'black';
            ctx.textBaseline = 'top';

            // 计算画布高度并设置
            const requiredHeight = lines.length * lineHeight + 3 * yOffset;
            canvas.height = Math.max(requiredHeight, 250); // 最小高度

            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'black';

            // 绘制文本
            lines.forEach((line, index) => {
                const angle = (Math.random() - 0.5) * (Math.PI / 9); // 缩小旋转角度范围
                ctx.save();
                ctx.translate(xOffset, yOffset + index * lineHeight);
                ctx.rotate(angle);
                ctx.fillText(line, 0, 0);
                ctx.restore();
            });

            // 绘制不规则线段
            const existingSlopes = [];
            const numLines = Math.floor((canvas.width * canvas.height) / 400); // 线条数量

            for (let i = 0; i < numLines; i++) {
                const x1 = Math.random() * canvas.width;
                const y1 = Math.random() * canvas.height;
                const x2 = Math.random() * canvas.width;
                const y2 = Math.random() * canvas.height;

                const deltaX = x2 - x1;
                const deltaY = y2 - y1;
                const slope = deltaX !== 0 ? deltaY / deltaX : Infinity; // 处理垂直线

                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.strokeStyle = 'rgba(0,0,0,0.9)'; // 对文字的遮挡
                ctx.lineWidth = Math.random() * 0.5 + 0.1; // 减小线条宽度范围
                ctx.stroke();

                existingSlopes.push(slope);
            }

            // 绘制不规则点
            const numPoints = Math.floor((canvas.width * canvas.height) / 100); // 增加点的数量
            for (let i = 0; i < numPoints; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const radius = Math.random() * 1.5 + 0.5; // 点的半径在0.5到2之间

                ctx.beginPath();
                ctx.arc(x, y, radius, 0, 2 * Math.PI);
                ctx.fillStyle = 'rgba(0,0,0,0.9)'; // 降低不透明度
                ctx.fill();
            }

            // 绘制随机间距的x轴平行线
            const numXLines = Math.floor(canvas.height / 2); // 增加线条数量
            for (let i = 0; i < numXLines; i++) {
                let y = Math.random() * canvas.height;
                const gap = Math.random() * 1; // 

                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.strokeStyle = 'rgba(0,0,0,0.9)'; // 降低不透明度
                ctx.lineWidth = 0.2; // 固定较细的线宽
                ctx.stroke();

                y += gap;
            }

            // 绘制随机间距的y轴平行线
            const numYLines = Math.floor(canvas.width / 3); // 增加线条数量
            for (let i = 0; i < numYLines; i++) {
                let x = Math.random() * canvas.width;
                const gap = Math.random() * 2; // 最大间距

                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.strokeStyle = 'rgba(0,0,0,0.9)'; // 降低不透明度
                ctx.lineWidth = 0.2; // 固定较细的线宽
                ctx.stroke();

                x += gap;
            }
        }

        // 根据窗口大小自动调整画布尺寸
        function adjustCanvasSize() {
            const canvas = document.getElementById('canvas');
            const maxCharsPerLine = parseInt(document.getElementById('maxCharsInput').value, 10) || 30;
            const desiredWidth = Math.max(maxCharsPerLine * 10 + 100, 400); // 增加宽度以适应更大的字体
            canvas.width = desiredWidth;
            // 高度由生成图片时设置
        }

        // 窗口大小改变时调用调整画布尺寸的函数
        window.addEventListener('resize', adjustCanvasSize);

        // 初始时调整画布尺寸
        window.addEventListener('DOMContentLoaded', adjustCanvasSize);

        // 将文本按照每行最大字符数分割成多行的函数
        function splitTextIntoLines(text, maxCharsPerLine) {
            const lines = [];
            let currentIndex = 0;

            while (currentIndex < text.length) {
                const remaining = text.length - currentIndex;
                if (remaining <= maxCharsPerLine) {
                    lines.push(text.substring(currentIndex));
                    break;
                }

                // 优先在空格处分割（适用于英文）
                let line = text.substring(currentIndex, currentIndex + maxCharsPerLine);
                const lastSpace = line.lastIndexOf(' ');
                if (lastSpace !== -1) {
                    lines.push(line.substring(0, lastSpace));
                    currentIndex += lastSpace + 1;
                } else {
                    // 对于没有空格的情况（如中文），直接强制断行
                    lines.push(line);
                    currentIndex += maxCharsPerLine;
                }
            }

            return lines;
        }
    </script>
</body>
</html>